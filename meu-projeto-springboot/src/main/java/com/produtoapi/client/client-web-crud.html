<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente Web Externo</title>
</head>

<body>
    <h1>CRUD - Cliente HTML/JAVASCRIPT</h1>

    <!-- FORMULÁRIO -->
    <div>
        <label for="id">ID:</label>
        <input type="text" id="id">
    </div>
    <div>
        <label for="nome">Nome:</label>
        <input type="text" id="nome">
    </div>
    <div>
        <label for="preco">Preço:</label>
        <input type="text" id="preco">
    </div>
    <div>
        <label for="quantidade">Quantidade:</label>
        <input type="text" id="quantidade">
    </div>
    <div>
        <label for="status">Status:</label>
        <input type="text" id="status">
    </div>

    <!-- BOTÕES -->
    <button onclick="salvar()" style="background-color: green; color: white;">Salvar</button>
    <button onclick="atualizar()" style="background-color: red; color: white;">Atualizar</button>
    <button onclick="deletar()" style="background-color: blue; color: white;">Deletar</button>
    <button onclick="carregarCampos()" style="background-color: gray; color: black;">Consultar</button>
    <button onclick="limparCampos()" style="background-color: brown; color: white;">Limpar Campos</button>

    <h2>Lista de Produtos</h2>

    <!-- TABELA -->
    <table id="produtosTable" border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>NOME</th>
                <th>PREÇO</th>
                <th>QUANTIDADE</th>
                <th>DISPONIBILIDADE</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- TOTAL DE PRODUTOS -->
    <p id="total-produtos"></p>

    <!-- MENSAGEM DE ERRO -->
    <p id="erroMensagem" style="color: red; display: none;">Erro ao carregar produtos.</p>

    <script>
        const BASE_URL = "http://localhost:8080/produtos";

        function getProdutoFromForm() {
            return {
                nome: document.getElementById("nome").value,
                preco: parseFloat(document.getElementById("preco").value),
                quantidade: parseInt(document.getElementById("quantidade").value),
                status: document.getElementById("status").value
            };
        }

        function listarTodos() {
            fetch(BASE_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Erro: " + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const tableBody = document
                        .getElementById("produtosTable")
                        .getElementsByTagName("tbody")[0];

                    // LIMPA TABELA ANTES DE PREENCHER
                    tableBody.innerHTML = "";

                    let totalProdutos = 0;

                    data.forEach(produto => {
                        const row = tableBody.insertRow();

                        row.insertCell(0).textContent = produto.id;
                        row.insertCell(1).textContent = produto.nome;
                        row.insertCell(2).textContent = produto.preco;
                        row.insertCell(3).textContent = produto.quantidade;
                        row.insertCell(4).textContent = produto.status;

                        totalProdutos++;
                    });

                    // MOSTRAR TOTAL
                    document.getElementById("total-produtos").textContent =
                        "Total de Produtos: " + totalProdutos;

                    // ESCONDE ERRO SE TUDO DEU CERTO
                    document.getElementById("erroMensagem").style.display = "none";
                })
                .catch(error => {
                    console.error("Erro ao buscar produtos:", error);
                    document.getElementById("erroMensagem").style.display = "block";
                });
        }

        async function salvar() {
            const produto = getProdutoFromForm();

            await fetch(BASE_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(produto)
            });

            listarTodos();
        }

        async function atualizar() {
            const produto = getProdutoFromForm();
            const id = document.getElementById("id").value;

            await fetch(`${BASE_URL}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(produto)
            });

            listarTodos();
        }

        async function deletar() {
            const id = document.getElementById("id").value;

            await fetch(`${BASE_URL}/${id}`, {
                method: "DELETE"
            });

            listarTodos();
        }

        function carregarCampos() {
            const id = document.getElementById("id").value;

            fetch(`${BASE_URL}/${id}`)
                .then(response => response.json())
                .then(produto => {
                    document.getElementById("nome").value = produto.nome;
                    document.getElementById("preco").value = produto.preco;
                    document.getElementById("quantidade").value = produto.quantidade;
                    document.getElementById("status").value = produto.status;
                })
                .catch(error => console.error("Erro ao consultar produto:", error));
        }

        function limparCampos() {
            document.getElementById("id").value = "";
            document.getElementById("nome").value = "";
            document.getElementById("preco").value = "";
            document.getElementById("quantidade").value = "";
            document.getElementById("status").value = "";
        }

        document.addEventListener("DOMContentLoaded", listarTodos);
    </script>

</body>

</html>
